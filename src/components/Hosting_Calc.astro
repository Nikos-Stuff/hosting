<div>
  <div class="space-y-4 animate" id="calculator">
    <!-- Custom Dropdown location -->
    <div class="relative" id="location_dropdown">
      <p class="block text-sm font-medium mb-1">Choose Location:</p>

      <div
        id="location_selected"
        class="border border-black/15 dark:border-white/20 rounded-lg px-4 py-3 cursor-pointer flex justify-between items-center select-none hover:bg-black/5 dark:hover:bg-white/10 transition-all duration-300 ease-in-out"
      >
        <div>
          <span class="fi fi-xx mr-5"></span>Click to choose location
        </div>
      </div>

      <div
        id="location_options"
        class="absolute w-full rounded-lg mt-1 overflow-auto max-h-0 transition-all duration-300 z-51 dark:bg-black bg-white shadow-lg"
      >
        <div
          class="px-4 py-3 flex justify-between items-center cursor-pointer hover:bg-black/5 dark:hover:bg-white/10"
          data-location_name="europe_free"
        >
          <div>
            <span class="fi fi-eu mr-5"></span>Europe - Test Node
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Dropdown Eggs -->
    <div class="relative" id="egg_dropdown">
      <p class="block text-sm font-medium mb-1">Select "egg":</p>

      <div
        id="egg_selected"
        class="border border-black/15 dark:border-white/20 rounded-lg px-4 py-3 cursor-pointer flex justify-between items-center select-none hover:bg-black/5 dark:hover:bg-white/10 transition-all duration-300 ease-in-out"
      >
        Click to choose egg
      </div>
      <a
        href="https://forms.gle/KXNLmxLib8ERo9vT7"
        target="_blank"
        class="text-xs italic"
      >
        We're missing something? Let us know!
      </a>

      <div
        id="egg_options"
        class="absolute w-full rounded-lg mt-1 overflow-auto max-h-0 transition-all duration-300 z-50 dark:bg-black bg-white shadow-lg"
      >
        <div
          class="p-3 grid grid-cols-3 md:grid-cols-6 gap-2 justify-items-center"
        >
          <div
            hidden
            id="egg_template"
            data-egg_id="?"
            class="flex flex-col items-center px-2 py-3 rounded-lg cursor-pointer hover:bg-black/5 dark:hover:bg-white/10 select-none transition-all"
          >
            <figure
              class="w-16 h-16 rounded-md overflow-hidden bg-black/5 dark:bg-white/5 flex items-center justify-center"
            >
              <img src="" alt="Loading" class="w-full h-full object-cover" />
            </figure>
            <span class="text-sm mt-2 text-center">Downloading...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Email Input for order -->
    <div class="relative">
      <p class="block text-sm font-medium mb-1">Your Email:</p>
      <input
        id="client_email"
        type="text"
        placeholder="example@xyz.com"
        class="w-full border border-black/15 dark:border-white/20 rounded-lg px-4 py-3 cursor-pointer flex justify-between items-center select-none hover:bg-black/5 dark:hover:bg-white/10 transition-all duration-300 ease-in-out"
      />
    </div>

    <div class="flex justify-center my-4">
      <div class="w-full max-w-90 h-19.5 flex items-center justify-center">
        <!-- reserved box to avoid CLS and keep centered -->
        <div
          class="cf-turnstile"
          data-sitekey="0x4AAAAAACBNatxTQCTb20u7"
          data-theme="light"
          data-size="normal"
          data-callback="onTurnstileSuccess"
          data-expired-callback="onTurnstileExpired"
          style="min-height:78px;"
        >
        </div>
      </div>
    </div>

    <div class="animate">
      <button
        id="place_order_btn"
        class="group w-full p-4 mt-5 gap-3 flex items-center border rounded-lg hover:bg-black/5 hover:dark:bg-white/10 border-black/15 dark:border-white/20 transition-all duration-300 ease-in-out"
      >
        <span
          class="w-full z-10 relative group-hover:text-black group-hover:dark:text-white text-center transition-color duration-300"
        >
          Get My Server!
        </span>
      </button>
      <a href="/legal">
        <small>
          By creating a server, you agree to our <strong
            >Terms of Service</strong
          > & <strong>Privacy Policy</strong>.
        </small>
      </a>
    </div>
  </div>
</div>

<script>
  // ------------------------------
  // DOM ELEMENT REFERENCES
  // ------------------------------
  const locationDropdown = document.getElementById(
    "location_dropdown"
  ) as HTMLElement | null;
  const locationSelected = document.getElementById(
    "location_selected"
  ) as HTMLElement | null;
  const locationOptions = document.getElementById(
    "location_options"
  ) as HTMLElement | null;

  const eggDropdown = document.getElementById(
    "egg_dropdown"
  ) as HTMLElement | null;
  const eggSelected = document.getElementById(
    "egg_selected"
  ) as HTMLElement | null;
  const eggOptions = document.getElementById(
    "egg_options"
  ) as HTMLElement | null;
  const eggTemplate = document.getElementById(
    "egg_template"
  ) as HTMLElement | null;

  const clientEmailInput = document.getElementById(
    "client_email"
  ) as HTMLInputElement | null;
  const placeOrderBtn = document.getElementById(
    "place_order_btn"
  ) as HTMLElement | null;
  const order_blocker = document.getElementById(
    "order_blocker"
  ) as HTMLElement | null;
  const order_status = document.getElementById(
    "order_activity"
  ) as HTMLElement | null;
  // ------------------------------

  const egg_list =
    "https://api.nikostuff.com/v2/hosting/pelican_data?list_eggs"; // API for eggs
  const order_api =
    "https://api.nikostuff.com/v2/hosting/order_manager?place_order"; // API for placing / renewing stuff

  const data_storage: {
    egg_id: string;
    client_email: string;
    location: string;
    turnstile_token: string;
  } = {
    egg_id: "",
    client_email: "",
    location: "",
    turnstile_token: "",
  };

  // ------------------------------
  // CLIENT EMAIL INPUT HANDLING (debounce 2s)
  // ------------------------------
  let emailTimer: ReturnType<typeof setTimeout> | undefined = undefined;
  function commitEmail() {
    if (!clientEmailInput) return;
    const val = clientEmailInput.value.trim();
    data_storage.client_email = val;
  }
  clientEmailInput?.addEventListener("input", () => {
    if (emailTimer) clearTimeout(emailTimer);
    emailTimer = setTimeout(commitEmail, 2000);
  });
  // also commit on blur immediately
  clientEmailInput?.addEventListener("blur", () => {
    if (emailTimer) clearTimeout(emailTimer);
    commitEmail();
  });

  // ------------------------------
  // Cloudflare Turnstile callbacks
  // ------------------------------
  (window as any).onTurnstileSuccess = (token: string) => {
    data_storage.turnstile_token = token || "";
  };
  (window as any).onTurnstileExpired = () => {
    data_storage.turnstile_token = "";
  };

  // ------------------------------
  // FETCH EGGS
  // ------------------------------
  async function fetchEggs() {
    try {
      const res = await fetch(egg_list);
      if (!res.ok) throw new Error("Błąd pobierania jajek");

      const data = await res.json();
      const grid = eggOptions?.querySelector(".p-3");
      if (!grid) return;

      // Create egg options
      for (const egg of data) {
        const eggOption = eggTemplate?.cloneNode(true);
        if (!(eggOption instanceof HTMLElement)) continue;

        eggOption.id = "";
        eggOption.classList.add("egg_option");
        eggOption.setAttribute("data-egg_id", egg.id);
        eggOption.hidden = false;

        const img = eggOption.querySelector("img");
        if (img) {
          (img as HTMLImageElement).src = egg.image || "/imgs/plc.png";
          (img as HTMLImageElement).alt = egg.name || "";
        }

        const label = eggOption.querySelector("span");
        if (label) (label as HTMLElement).textContent = egg.name || "";

        grid.appendChild(eggOption);

        // small delay for rendering large number of eggs
        await new Promise((resolve) => setTimeout(resolve, 100));
      }

      // Add click listeners for eggs
      eggOptions?.querySelectorAll(".egg_option")?.forEach((option) => {
        option.addEventListener("click", () => {
          if (!eggSelected || !eggOptions) return;
          const txt = option.querySelector("span")?.textContent?.trim() || "";
          eggSelected.textContent = txt;
          eggOptions.classList.remove("max-h-60");
          const selectedEggId = option.getAttribute("data-egg_id") || "";
          // store selected egg for ordering
          data_storage.egg_id = selectedEggId;
        });
      });
    } catch (e) {
      console.error(e);
    }
  }

  // ------------------------------
  // DROPDOWN TOGGLE HANDLERS
  // ------------------------------
  eggSelected?.addEventListener("click", () => {
    eggOptions?.classList.toggle("max-h-60");
  });

  locationSelected?.addEventListener("click", () => {
    locationOptions?.classList.toggle("max-h-60");
  });
  // ------------------------------

  // Click outside to close dropdowns
  document.addEventListener("click", (e) => {
    const target = e.target;
    if (!(target instanceof Node) || !locationDropdown?.contains(target)) {
      locationOptions?.classList.remove("max-h-60");
    }
    if (!(target instanceof Node) || !eggDropdown?.contains(target)) {
      eggOptions?.classList.remove("max-h-60");
    }
  });

  // ------------------------------
  // LOCATION OPTION SELECT
  // ------------------------------
  locationOptions
    ?.querySelectorAll("[data-location_name]")
    ?.forEach((option) => {
      option.addEventListener("click", () => {
        if (!locationSelected || !locationOptions) return;
        locationSelected.innerHTML = option.innerHTML;
        // store selected location for cost calc
        const selected = option.getAttribute("data-location_name") || "";
        locationOptions.classList.remove("max-h-60");
        // add to data storage for ordering
        data_storage.location = selected;
      });
    });

  placeOrderBtn?.addEventListener("click", async () => {
    // ensure latest email committed before sending
    if (emailTimer) clearTimeout(emailTimer);
    commitEmail();

    console.log("Placing order with data:", data_storage);
    // Simply unhide the order blocker and send the data to the order API without any further handling for now ( everything is server side )
    if (order_blocker) order_blocker.removeAttribute("hidden");
    if (!order_status) return;
    try {
      order_status.textContent = "Waiting for API response...";
      const res = await fetch(order_api, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data_storage),
      });

      if (!res.ok)
        throw new Error("Unknown error... (Can't reach the target URL)");

      const data = await res.json();

      if (data.error) throw new Error(data.error);

      // Redirect to payment / order page
      if (data.status === "task_created") {
        order_status.textContent =
          "Action completed successfully! Redirecting...";
        setTimeout(() => {
          if (order_blocker) order_blocker.setAttribute("hidden", "true");
          window.location.href = "https://panel.nikostuff.com";
        }, 3000);
      } else {
        if (order_blocker) order_blocker.setAttribute("hidden", "true");
        alert("Oops. Something went wrong. Please try again later.");
      }
    } catch (err) {
      console.error(err);
      if (order_blocker) order_blocker.setAttribute("hidden", "true");
      const errMsg =
        err && typeof err === "object" && "message" in err
          ? (err as any).message
          : String(err);
      alert("Oops. Something went wrong. API returned: " + errMsg);
    }

    // Refresh Turnstile
    (window as any).turnstile.reset();
  });

  // ------------------------------
  // INITIAL CALCULATION / EGGS INIT
  // ------------------------------
  fetchEggs();
</script>
