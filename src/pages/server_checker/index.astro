---
import PageLayout from "@layouts/PageLayout.astro";
import { SITE } from "@consts";
import MeteorShower from "@components/MeteorShower.astro";
import TwinklingStars from "@components/TwinklingStars.astro";
import BackgroundFX from "@components/page_effects/BackgroundFX.astro";
import POD from "@components/POD.astro";
import FancyDiv from "@components/FancyDiv.astro";
---

<PageLayout title="Server Status Checker" description={SITE.DESCRIPTION}>
  <!-- <script is:inline data-astro-rerun async src="/js/scroll_animation.js"
  ></script> -->

  <POD />
  <!-- Light Mode: Particles -->
  <div class="absolute inset-0 block dark:hidden">
    <div id="particles1" class="fixed inset-0"></div>
    <div id="particles2" class="fixed inset-0"></div>
    <div id="particles3" class="fixed inset-0"></div>
  </div>

  <!-- Dark Theme: Stars -->
  <div class="absolute inset-0 hidden dark:block">
    <div id="stars1" class="fixed inset-0"></div>
    <div id="stars2" class="fixed inset-0"></div>
    <div id="stars3" class="fixed inset-0"></div>
  </div>

  <!-- Dark Theme: Twinkling Stars / Metors -->
  <div id="galaxy" class="fixed inset-0">
    <div class="hidden dark:block">
      <TwinklingStars />
      <MeteorShower />
    </div>
  </div>

  <!-- <script is:inline defer src="/js/bg.js"></script> -->
  <BackgroundFX />

  <!-- HERO -->
  <section
    id="hero_fade"
    class="snap-center grid w-full h-[20svh] place-items-center relative text-center overflow-hidden transition-all"
  >
    <!-- <div id="planetcont" class='animate absolute inset-0 top-3/4 overflow-hidden z-10'> PLANET HAS BEEN REMOVED FOR A TEST NEW LAYOUT 
            <div id="crescent"
                 class='absolute top-0 left-1/2 -translate-x-1/2 w-[250vw] min-h-[100vh] aspect-square rounded-full p-[1px] bg-gradient-to-b from-black/25 dark:from-white/75 from-0% to-transparent to-5%'>
                <div id="planet"
                     class='w-full h-full bg-white dark:bg-black rounded-full p-[1px] overflow-hidden flex justify-center'>
                    <div id="blur" class='w-full h-5 rounded-full bg-neutral-900/25 dark:bg-white/25 blur-2xl'/>
                </div>
            </div>
        </div> -->
  </section>

  <div class="relative">
    <div class="w-svw">
      <FancyDiv isAnimated={true} theme="default_big" margin_bottom="10">
        <div class="transition-all">
          <p
            class="text-xl md:text-2xl lg:text-3xl font-bold uppercase text-black dark:text-white animate"
          >
            Server Checker
          </p>
          <p class="font-bold text-sm mb-2 animate">
            Check the status of your server & troubleshoot the issues
          </p>

          <div class="space-y-4 animate" id="calculator">
            <!-- IP Input -->
            <div class="relative mb-0" id="ip_input_box">
              <input
                id="ip_input"
                type="text"
                placeholder="my.server.net or 127.0.0.1:1234"
                class="w-full p-4 mt-5 mb-0 border rounded-lg
                    bg-transparent
                  border-black/15 dark:border-white/20
                  hover:bg-black/5 hover:dark:bg-white/10
                    focus:outline-none
                  focus:border-black/40 dark:focus:border-white/40
                    focus:ring-2 focus:ring-black/20 dark:focus:ring-white/20
                    focus:ring-offset-0
                    transition-all duration-300 ease-out"
              />
            </div>
            <p class="mb-10 mt-0">
              <small>
                Analyzed by Gemini AI.
                <span class="block sm:inline">
                  Only technical network data is processed; no player data or
                  server files are ever shared or stored.</span
                >
              </small>
            </p>

            <!-- Explanation area -->
            <div
              id="explanation_area"
              class="font-mono text-sm overflow-scroll h-60 w-full p-4 mt-5 border rounded-lg
              flex flex-col justify-between gap-2
            hover:bg-black/5 hover:dark:bg-white/10
            border-black/15 dark:border-white/20
              transition-all duration-300 ease-in-out hide_scrollbar
              dark:prose-invert prose max-w-full"
            >
            </div>

            <!-- Debug console -->
            <div
              id="debug_console"
              class="font-mono text-sm overflow-scroll h-30 w-full p-4 mt-5 border rounded-lg
              flex flex-col justify-between gap-2
            hover:bg-black/5 hover:dark:bg-white/10
            border-black/15 dark:border-white/20
              transition-all duration-300 ease-in-out hide_scrollbar"
            >
              <div id="log_messages">Waiting for input...</div>
              <div
                id="progress-line"
                class="text-gray-700 dark:text-gray-300 whitespace-pre"
              >
                <!-- progress will update here -->
              </div>
            </div>
          </div>
        </div>
      </FancyDiv>
    </div>
  </div>
</PageLayout>

<script>
  const ip_input = document.getElementById(
    "ip_input",
  ) as HTMLButtonElement | null;
  const debugConsole = document.getElementById(
    "debug_console",
  ) as HTMLDivElement | null;
  const explanationArea = document.getElementById(
    "explanation_area",
  ) as HTMLDivElement | null;

  if (!ip_input || !debugConsole) {
    throw new Error("Required DOM elements not found");
  }

  const api_url = "https://api.nikostuff.com/v2/hosting/server_checker?ip=";

  type LogLevel = "info" | "warn" | "error" | "success";

  const LOG_COLORS: Record<LogLevel, string> = {
    info: "text-blue-600 dark:text-blue-400",
    warn: "text-yellow-600 dark:text-yellow-400",
    error: "text-red-600 dark:text-red-400",
    success: "text-green-600 dark:text-green-400",
  };

  function clear_log() {
    const container = document.getElementById("log_messages");
    if (container) {
      container.innerHTML = "";
    }
  }

  function log(message: string, level: LogLevel = "info") {
    const time = new Date().toLocaleTimeString();
    const line = `
    <div class="${LOG_COLORS[level]}">
      [${time}] ${message}
    </div>
  `;
    const container = document.getElementById("log_messages");
    if (container) {
      container.innerHTML += line;
      debugConsole!.scrollTop = debugConsole!.scrollHeight;
    }
  }
  function parseMarkdown(text: string): string {
    let html = text
      .replace(
        /\[([^\]]+)\]\(([^)]+)\)/g,
        '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">$1</a>',
      )

      .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")

      .replace(/\*([^\s\*][^\*]*[^\s\*])\*/g, "<em>$1</em>")

      .replace(/^\s*[\*\-]\s+(.*)$/gim, "<li>$1</li>");

    html = html.replace(/(<li>.*<\/li>)/gms, "<ul>$1</ul>");

    return html
      .split("\n\n")
      .map((para) => `<p>${para.trim().replace(/\n/g, "<br>")}</p>`)
      .join("");
  }

  ip_input.addEventListener("change", async () => {
    const ip = ip_input.value.trim();
    if (!ip) return;

    clear_log();
    log(`Initializing scan for: ${ip}...`, "info");

    try {
      const response = await fetch(`${api_url}${encodeURIComponent(ip)}`);

      if (!response.ok) {
        if (response.status === 429)
          throw new Error("Rate limit exceeded. Slow down!");
        throw new Error(`Server returned ${response.status}`);
      }

      const data = await response.json();

      // Log Status to Console
      const javaStatus = data.raw_analysis.java.reachable
        ? "ONLINE"
        : "OFFLINE";
      const bedrockStatus = data.raw_analysis.bedrock.reachable
        ? "ONLINE"
        : "OFFLINE";

      log(
        `Java Status: ${javaStatus}`,
        data.raw_analysis.java.reachable ? "success" : "error",
      );
      log(
        `Bedrock Status: ${bedrockStatus}`,
        data.raw_analysis.bedrock.reachable ? "success" : "error",
      );

      // Display the AI Explanation
      if (explanationArea) {
        const htmlContent = parseMarkdown(data.explanation);
        explanationArea.innerHTML = htmlContent;
      }

      log("Analysis complete.", "success");
    } catch (err: any) {
      log(`Error: ${err.message}`, "error");
      if (explanationArea)
        explanationArea.innerHTML = "Failed to retrieve analysis.";
    }
  });
</script>
